{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}問題閲覧{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/view_questions.css' %}">
{% endblock %}

{% block extra_js %}
<!-- <script src="{% static 'js/view_questions.js' %}"></script> -->
{% endblock %}

{% block content %}
<div class="button-group">
    <a href="{% url 'view_folder' folder_id %}" class="nav-button close-button">✕</a>
    <div class="spacer"></div>

    <form method="post" action="{% url 'quiz_result' %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="nav-button close-button">終了</button>
    </form>

    {% if prev_question_id %}
    <a href="?question_id={{ prev_question_id }}" class="nav-button prev-button">◁</a>
    {% else %}
    <button class="nav-button prev-button" disabled>◁</button>
    {% endif %}

    {% if next_question_id %}
    <a href="?question_id={{ next_question_id }}" class="nav-button next-button">▷</a>
    {% else %}
    <button class="nav-button next-button" disabled>▷</button>
    {% endif %}
</div>

{% for question in questions %}
<div class="question-box">
    {{ question.content }}
</div>

<div class="answer-box">
    {% with answers_map|dict_get:question.answer_id as answer %}
    {% if answer %}
    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="question_id" value="{{ question.question_id }}">

        {% if not answered_question_id or answered_question_id != question.question_id|stringformat:"s" %}
        {% if answer.options and answer.options|length > 0 %}
        {% if answer.correct|length > 1 %}
        <!-- 複数正解 → チェックボックス -->
        {% for option in answer.options %}
        <label>
            <input type="checkbox" name="answer" value="{{ forloop.counter }}">
            {{ option }}
        </label><br>
        {% endfor %}
        {% else %}
        <!-- 単一正解 → ラジオボタン -->
        {% for option in answer.options %}
        <label>
            <input type="radio" name="answer" value="{{ forloop.counter }}">
            {{ option }}
        </label><br>
        {% endfor %}
        {% endif %}
        {% else %}
        <!-- テキスト入力 -->
        <input type="text" name="answer" class="answer-textbox" placeholder="解答を入力">
        {% endif %}
        <button type="submit">解答する</button>
        {% else %}
        <!-- 解答後の表示 -->
        <p class="correct-answer">
            正解：
            {% for c in answer.correct %}
            {{ c }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </p>
        <p class="result-message">{{ result_message }}</p>
        {% endif %}
    </form>
    {% else %}
    <p>解答情報が見つかりません。</p>
    {% endif %}
    {% endwith %}
</div>
{% empty %}
<p>表示できる問題がありません。</p>
{% endfor %}
{% endblock %}